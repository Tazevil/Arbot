{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://arbot.local/schemas/arbot-vision-analysis.schema.json",
  "title": "ArBot-Vision Analysis",
  "type": "object",
  "required": ["meta","context","source_file","vision","presentation","validation"],
  "properties": {
    "meta": {
      "type": "object",
      "required": ["SOP_name","SOP_ver","generated_at","tool_list"],
      "properties": {
        "SOP_name": { "type": "string" },
        "SOP_ver": { "type": "string" },
        "generated_at": { "type": "string", "format": "date-time" },
        "tool_list": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "context": {
      "type": "object",
      "required": ["project_ID","project_name","project_type","phase_ID","phase_name"],
      "properties": {
        "project_ID": { "type": "string" },
        "project_name": { "type": "string" },
        "project_type": { "type": "string" },
        "phase_ID": { "type": "string" },
        "phase_name": { "type": "string" }
      },
      "additionalProperties": false
    },
    "source_file": {
      "type": "object",
      "required": ["file_cat","file_ID","file_name","file_ext","file_img_width","file_img_height","zone_ID","zone_name","cat_ID","cat_img_ID","cat_name","viewtype_ID","viewtype_name"],
      "properties": {
        "file_cat": { "type": "string", "enum": ["Photo","Doc","Plan"] },
        "file_ID": { "type": "string" },
        "file_name": { "type": "string" },
        "file_ext": { "type": "string" },
        "file_img_width": { "type": "integer", "minimum": 1 },
        "file_img_height": { "type": "integer", "minimum": 1 },
        "file_date": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
        "zone_ID": { "type": "integer" },
        "zone_name": { "type": "string" },
        "cat_ID": { "type": "integer" },
        "cat_img_ID": { "type": "string" },
        "cat_name": { "type": "string" },
        "viewtype_ID": { "type": "string" },
        "viewtype_name": { "type": "string" }
      },
      "additionalProperties": false
    },
    "vision": {
      "type": "object",
      "required": ["passes","scales","nms_iou","refine_below","trust_score","focus_type","target_zone","viewtype_ID","viewtype_name","evidence_crops","annotations","metrics","defects"],
      "properties": {
        "passes": { "type": "integer", "minimum": 1 },
        "scales": { "type": "array", "items": { "type": "number" }, "minItems": 1 },
        "nms_iou": { "type": "number", "minimum": 0, "maximum": 1 },
        "refine_below": { "type": "number", "minimum": 0, "maximum": 1 },
        "trust_score": { "type": "number", "minimum": 0, "maximum": 1 },
        "focus_type": { "type": "string" },
        "target_zone": { "type": "string" },
        "viewtype_ID": { "type": "string" },
        "viewtype_name": { "type": "string" },
        "evidence_crops": { "type": "array", "items": { "type": "string" } },
        "annotations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["ann_ID","ann_type","ann_label","ann_linked_def_ID","ann_layer","bbox_xyxy_norm","ann_confidence","style"],
            "properties": {
              "ann_ID": { "type": "string" },
              "ann_type": { "type": "string", "enum": ["bbox","polygon","polyline","mask"] },
              "ann_label": { "type": "string" },
              "ann_linked_def_ID": { "type": "string" },
              "ann_layer": { "type": "string" },
              "bbox_xyxy_norm": {
                "type": "array",
                "items": { "type": "number" },
                "minItems": 4,
                "maxItems": 4
              },
              "polygon_norm": {
                "type": "array",
                "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              },
              "polyline_norm": {
                "type": "array",
                "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              },
              "mask_polygon_norm": {
                "type": "array",
                "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              },
              "ann_confidence": { "type": "number", "minimum": 0, "maximum": 1 },
              "style": {
                "type": "object",
                "properties": {
                  "stroke": { "type": "string" },
                  "stroke_width": { "type": "number" },
                  "fill": { "type": "string" },
                  "opacity": { "type": "number", "minimum": 0, "maximum": 1 }
                },
                "additionalProperties": true
              }
            },
            "additionalProperties": false
          }
        },
        "metrics": { "type": "array", "items": { "type": "object" } },
        "defects": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id_defaut","categorie","type_defaut","resume","regle_ref","gravite","priorite","temps","incertitude","bbox_xyxy_norm","annotation_refs","origin_viewtype_ID","origin_layer"],
            "properties": {
              "id_defaut": { "type": "string" },
              "categorie": { "type": "string" },
              "type_defaut": { "type": "string" },
              "resume": { "type": "string" },
              "details": { "type": "string" },
              "regle_ref": {
                "type": "object",
                "required": ["norme","partie"],
                "properties": {
                  "norme": { "type": "string" },
                  "partie": { "type": "string" }
                },
                "additionalProperties": false
              },
              "gravite": { "type": "integer", "enum": [1,2,3] },
              "priorite": { "type": "integer", "enum": [1,2,3] },
              "temps": { "type": "integer", "enum": [1,2,3] },
              "incertitude": { "type": "number", "minimum": 0, "maximum": 1 },
              "bbox_xyxy_norm": {
                "type": "array",
                "items": { "type": "number" },
                "minItems": 4,
                "maxItems": 4
              },
              "polygon_norm": {
                "type": "array",
                "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              },
              "polyline_norm": {
                "type": "array",
                "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              },
              "mask_polygon_norm": {
                "type": "array",
                "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
              },
              "annotation_refs": { "type": "array", "items": { "type": "string" } },
              "evidence_summary": { "type": "string" },
              "origin_viewtype_ID": { "type": "string" },
              "origin_focus": { "type": "string" },
              "origin_layer": { "type": "string" }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "presentation": {
      "type": "object",
      "required": ["highlight_type","caption"],
      "properties": {
        "highlight_type": { "type": "string", "enum": ["bbox","polygon","polyline","mask"] },
        "points_norm": {
          "type": "array",
          "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }
        },
        "padded_bbox_norm": {
          "type": "array",
          "items": { "type": "number" },
          "minItems": 4,
          "maxItems": 4
        },
        "caption": { "type": "string" },
        "style": { "type": "string" },
        "refined": { "type": "boolean" },
        "confidence_before": { "type": "number", "minimum": 0, "maximum": 1 },
        "confidence_after": { "type": "number", "minimum": 0, "maximum": 1 }
      },
      "additionalProperties": false
    },
    "validation": {
      "type": "object",
      "required": ["ok","erreurs","avertissements"],
      "properties": {
        "ok": { "type": "boolean" },
        "erreurs": { "type": "array", "items": { "type": "string" } },
        "avertissements": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}